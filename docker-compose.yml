version: "3.8"

volumes:
  postgresql:
  postgresql_data:
  mongodb:

networks:
  dmz:
    driver: bridge
  service:
    driver: bridge
  data:
    driver: bridge

services:
  gateway:
    build: ./appliance/gateway
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      dmz:
      service:
        aliases:
          - "identity.phex.local"
    ports:
      - "443:443"

  identity:
    image: jboss/keycloak:14.0.0
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - service
      - data
    environment:
      KEYCLOAK_USER: ${KEYCLOAK_ADMINUSER}
      KEYCLOAK_PASSWORD: ${KEYCLOAK_ADMINUSER_PASSWORD}
      DB_VENDOR: postgres
      DB_ADDR: db
      DB_USER: ${DATABASE_USER}
      DB_PASSWORD: ${DATABASE_USER_PASSWORD}
      PROXY_ADDRESS_FORWARDING: "true"

  api:
    build:
      context: .
      dockerfile: api.dockerfile
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - service
      - data
    environment:
      DEBUG: "true"
    volumes:
      - ${PWD}/appliance/api:/opt/phex/api
      - ${PWD}/packages/core/phexcore:/venv/lib/python3.9/site-packages/phexcore
      - ${PWD}/packages/security/phexsec:/venv/lib/python3.9/site-packages/phexsec

  # api_1_1:
  #   build:
  #     context: .
  #     dockerfile: api.dockerfile
  #   logging:
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   networks:
  #     - service
  #     - data
  #   environment:
  #     DEBUG: "true"
  #     VERSION: "1.1"
  #   volumes:
  #     - ${PWD}/appliance/api/.env.cdein:/opt/phex/api/.env.cdein
  #     - ${PWD}/appliance/api/.env.development:/opt/phex/api/.env.development
  #     - ${PWD}/appliance/api/pyproject.toml:/opt/phex/api/pyproject.toml
  #     - ${PWD}/appliance/api/phexapi:/opt/phex/api/phexapi

  # api_1_2:
  #   build:
  #     context: .
  #     dockerfile: api.dockerfile
  #   logging:
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   networks:
  #     - service
  #     - data
  #   environment:
  #     DEBUG: "true"
  #     VERSION: "1.2"
  #   volumes:
  #     - ${PWD}/appliance/api/.env.cdein:/opt/phex/api/.env.cdein
  #     - ${PWD}/appliance/api/.env.development:/opt/phex/api/.env.development
  #     - ${PWD}/appliance/api/pyproject.toml:/opt/phex/api/pyproject.toml
  #     - ${PWD}/appliance/api/phexapi:/opt/phex/api/phexapi

#  client:
#    build: ./appliance/client
#    logging:
#      options:
#        max-size: "10m"
#        max-file: "3"
#    networks:
#      - service
#    environment:
#      DEBUG: "true"
#    volumes:
#      - ./appliance/client:/opt/app

  db:
    build: ./appliance/database
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - data
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_USER_PASSWORD}
    volumes:
      - postgresql:/var/lib/postgresql
      - postgresql_data:/var/lib/postgresql/data

  mongo:
    image: mongo:bionic
    logging:
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - data
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_USER_PASSWORD}
    volumes:
      - mongodb:/data
